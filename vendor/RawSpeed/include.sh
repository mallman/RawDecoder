#!/bin/bash

set -eu

# Values set in env-${PLATFORM}.sh will override these settings
# Modify env-${PLATFORM}.sh to change these settings, not here
C_COMPILER=clang
CXX_COMPILER=clang++
BUILD_CONFIG=Release
WITH_OPENMP=OFF
USE_BUNDLED_LLVMOPENMP=OFF
ALLOW_DOWNLOADING_LLVMOPENMP=OFF

CONFIG_FILE="${BASE_DIR}/env-${PLATFORM}.sh"

if [ -f "${CONFIG_FILE}" ]; then
  . "${CONFIG_FILE}"
fi

SOURCE_DIR="${BASE_DIR}/RawSpeed"

BUILD_DIR="${BASE_DIR}/build-${PLATFORM}"

config_and_build() {
  rm -rf "${BUILD_DIR}"

  cmake \
  -DCMAKE_SYSTEM_NAME=$CMAKE_SYSTEM_NAME \
  -DCMAKE_OSX_SYSROOT=$CMAKE_OSX_SYSROOT \
  -DBINARY_PACKAGE_BUILD=$BINARY_PACKAGE_BUILD \
  -DCMAKE_OSX_ARCHITECTURES="${ARCHS}" \
  -DBUILD_TESTING=OFF \
  -DBUILD_BENCHMARKING=OFF \
  -DUSE_BUNDLED_PUGIXML=ON \
  -DALLOW_DOWNLOADING_PUGIXML=ON \
  -DRAWSPEED_ENABLE_WERROR=OFF \
  -DWITH_JPEG=OFF \
  -DWITH_ZLIB=ON \
  -DWITH_OPENMP=$WITH_OPENMP \
  -DUSE_BUNDLED_LLVMOPENMP=$USE_BUNDLED_LLVMOPENMP \
  -DALLOW_DOWNLOADING_LLVMOPENMP=$ALLOW_DOWNLOADING_LLVMOPENMP \
  -DCMAKE_VERBOSE_MAKEFILE=OFF \
  -DRAWSPEED_ENABLE_DEBUG_INFO=ON \
  -DBUILD_FUZZERS=OFF \
  -DRAWSPEED_USE_LIBCXX=ON \
  -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=TRUE \
  -DCMAKE_BUILD_TYPE:STRING=$BUILD_CONFIG \
  -DCMAKE_C_COMPILER:FILEPATH="${C_COMPILER}" \
  -DCMAKE_CXX_COMPILER:FILEPATH="${CXX_COMPILER}" \
  -S"${SOURCE_DIR}" \
  -B"${BUILD_DIR}" \
  -G Ninja

  cmake \
  --build "${BUILD_DIR}" \
  --config $BUILD_CONFIG \
  --target rawspeed rawspeed_get_number_of_processor_cores --
}
